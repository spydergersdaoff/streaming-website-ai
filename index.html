<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualiseur de Site (URL Courte)</title>
    <!-- Chargement de Tailwind CSS pour un style moderne -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Configuration de la police Inter */
        html { font-family: 'Inter', sans-serif; }
        /* Style pour l'iframe et le conteneur */
        #site-container {
            height: 70vh; /* 70% de la hauteur du viewport */
            width: 100%;
            border-radius: 0.75rem; /* rounded-xl */
            overflow: hidden;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        #site-iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 sm:p-8">

    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-blue-800">Raccourcisseur et Visualiseur de Site</h1>
            <p class="mt-2 text-gray-600">Entrez une URL pour l'afficher et générer un lien court et partageable.</p>
        </header>

        <!-- Formulaire de Saisie d'URL -->
        <form id="url-form" class="bg-white p-6 rounded-xl shadow-lg mb-8 flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4">
            <input
                type="text"
                id="url-input"
                placeholder="Exemple : https://google.com ou apple.com"
                required
                class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150"
            />
            <button
                type="submit"
                id="submit-button"
                class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-150 shadow-md hover:shadow-lg disabled:opacity-50"
            >
                Générer & Afficher
            </button>
        </form>

        <!-- Section de l'Iframe et du Lien Partageable -->
        <div class="space-y-6">
            
            <!-- Avertissement de Sécurité / Technique -->
            <div id="warning-message" class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 p-4 rounded-lg hidden" role="alert">
                <p class="font-bold">Attention Technique !</p>
                <p class="text-sm">Si le site ne s'affiche pas, c'est qu'il bloque l'affichage dans une iframe (mesure de sécurité). Pour une vraie copie du contenu, il faudrait un serveur proxy dédié.</p>
            </div>

            <!-- Conteneur de l'Iframe -->
            <div id="site-container">
                <iframe 
                    id="site-iframe" 
                    src="https://placehold.co/1280x720/000000/FFFFFF?text=Entrez+une+URL+ci-dessus" 
                    title="Aperçu du site web cible"
                    allow="fullscreen"
                ></iframe>
            </div>

            <!-- Affichage du Lien Partageable -->
            <div class="bg-gray-100 p-4 rounded-xl shadow-inner">
                <p class="text-gray-700 font-medium mb-2">Lien Partageable Court :</p>
                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                    <input
                        type="text"
                        id="share-link-output"
                        readonly
                        value="Initialisation de la base de données..."
                        class="flex-grow p-3 text-sm border border-gray-300 rounded-lg bg-gray-50 overflow-hidden text-ellipsis"
                    />
                    <button
                        id="copy-button"
                        class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-150 flex-shrink-0 disabled:opacity-50"
                        disabled
                    >
                        Copier
                    </button>
                </div>
                <p id="auth-status" class="text-xs mt-2 text-gray-500 text-right">Statut Firebase : Connexion...</p>
            </div>

        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('url-form');
            const input = document.getElementById('url-input');
            const iframe = document.getElementById('site-iframe');
            const linkOutput = document.getElementById('share-link-output');
            const copyButton = document.getElementById('copy-button');
            const submitButton = document.getElementById('submit-button');
            const warningMessage = document.getElementById('warning-message');
            const authStatus = document.getElementById('auth-status');
            
            // Initialisation des variables globales
            const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            // L'URL de base pour la redirection (URL de cette page)
            const defaultBaseUrl = window.location.origin + window.location.pathname;

            let db = null;
            let auth = null;
            let userId = null;
            let isAuthReady = false;

            // --- FONCTIONS UTILITAIRES ---

            /**
             * Génère un code court aléatoire (6 caractères).
             */
            const generateShortCode = (length = 6) => {
                const characters = 'abcdefghijklmnopqrstuvwxyz0123456789';
                let result = '';
                for (let i = 0; i < length; i++) {
                    result += characters.charAt(Math.floor(Math.random() * characters.length));
                }
                return result;
            };

            /**
             * Assure que l'URL a un protocole (http/https).
             */
            const normalizeUrl = (url) => {
                let processedUrl = url.trim();
                if (!processedUrl.match(/^[a-zA-Z]+:\/\//)) {
                    processedUrl = 'https://' + processedUrl;
                }
                return processedUrl;
            };

            // --- LOGIQUE FIREBASE ---

            setLogLevel('debug');
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            /**
             * Sauvegarde la correspondance URL longue -> code court dans Firestore.
             */
            const saveShortUrl = async (longUrl) => {
                if (!isAuthReady) {
                    linkOutput.value = "Erreur : Firebase non prêt.";
                    return null;
                }
                
                linkOutput.value = "Génération du lien court...";
                copyButton.disabled = true;

                try {
                    const shortCode = generateShortCode();
                    // Path public pour le partage (/artifacts/{appId}/public/data/short_urls/{code})
                    const docRef = doc(db, `artifacts/${appId}/public/data/short_urls`, shortCode);
                    
                    await setDoc(docRef, {
                        url: longUrl,
                        createdAt: new Date().toISOString(),
                        createdBy: userId
                    });

                    const shortLink = `${defaultBaseUrl}?code=${shortCode}`;
                    linkOutput.value = shortLink;
                    copyButton.disabled = false;
                    
                    return shortLink;

                } catch (error) {
                    console.error("Erreur lors de la sauvegarde du lien court:", error);
                    linkOutput.value = "Erreur de génération du lien (voir console).";
                    copyButton.disabled = true;
                    return null;
                }
            };

            /**
             * Met à jour l'iframe et génère le lien partageable court.
             */
            const updateSite = async (url) => {
                const normalizedUrl = normalizeUrl(url);

                // 1. Mise à jour de l'iframe
                iframe.src = normalizedUrl;
                warningMessage.classList.remove('hidden'); // Afficher l'avertissement technique

                // 2. Génération et sauvegarde du lien court
                await saveShortUrl(normalizedUrl);
            };


            /**
             * Vérifie si un code court est présent dans l'URL et charge le site correspondant.
             */
            const checkInitialLoad = async () => {
                const urlParams = new URLSearchParams(window.location.search);
                const shortCode = urlParams.get('code');

                if (shortCode) {
                    linkOutput.value = `Chargement du site pour le code : ${shortCode}...`;

                    try {
                        // Path public
                        const docRef = doc(db, `artifacts/${appId}/public/data/short_urls`, shortCode);
                        const docSnap = await getDoc(docRef);

                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            const longUrl = data.url;
                            
                            // Charger le site
                            input.value = longUrl;
                            iframe.src = longUrl;
                            warningMessage.classList.remove('hidden');

                            // Mettre à jour le lien de sortie avec le lien court utilisé
                            const shortLink = `${defaultBaseUrl}?code=${shortCode}`;
                            linkOutput.value = shortLink;
                            copyButton.disabled = false;

                        } else {
                            linkOutput.value = `Code court "${shortCode}" non trouvé.`;
                            iframe.src = "https://placehold.co/1280x720/FF0000/FFFFFF?text=Lien+court+non+valide";
                        }
                    } catch (error) {
                        console.error("Erreur lors du chargement du lien court:", error);
                        linkOutput.value = "Erreur de connexion Firestore.";
                        iframe.src = "https://placehold.co/1280x720/FF0000/FFFFFF?text=Erreur+de+chargement";
                    }
                } else {
                    linkOutput.value = "Saisissez une URL pour générer le lien court...";
                }
            };


            // --- AUTHENTIFICATION ET DÉMARRAGE ---

            // Authentification et initialisation
            (async () => {
                try {
                    authStatus.textContent = "Statut Firebase : Connexion en cours...";
                    submitButton.disabled = true;

                    if (typeof __initial_auth_token !== 'undefined') {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                    userId = auth.currentUser?.uid || crypto.randomUUID();
                    isAuthReady = true;

                    authStatus.textContent = "Statut Firebase : Connecté (" + userId.substring(0, 8) + "...)";
                    submitButton.disabled = false;

                    // Exécuter la logique de chargement initial après l'authentification
                    await checkInitialLoad(); 
                } catch (error) {
                    console.error("Erreur Firebase Auth:", error);
                    authStatus.textContent = "Statut Firebase : Échec de connexion.";
                    linkOutput.value = "Erreur d'initialisation (voir console).";
                }
            })();


            // --- ÉVÉNEMENTS UTILISATEUR ---

            // Écouteur pour la soumission du formulaire
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                // Utiliser la fonction asynchrone updateSite
                updateSite(input.value);
            });
            
            // Écouteur pour le bouton de copie
            copyButton.addEventListener('click', () => {
                // Utilisation de la méthode compatible avec les iframes
                try {
                    linkOutput.select();
                    document.execCommand('copy');
                    copyButton.textContent = 'Copié !';
                    setTimeout(() => {
                        copyButton.textContent = 'Copier';
                    }, 2000);
                } catch (err) {
                    console.error('Impossible de copier le texte: ', err);
                }
            });
        });
    </script>
</body>
</html>
